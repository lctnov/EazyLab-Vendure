generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-arm64-openssl-3.0.x"]
  previewFeatures = ["postgresqlExtensions"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ========================
// ENUMS
// ========================
enum PriceStrategy {
  SUM
  FIXED
  PERCENT
}

enum OrderStatus {
  CART
  PENDING
  PAYMENT_SETTLED
  SHIPPED
  CANCELED
  EXPIRED
}

// ========================
// HỆ THỐNG NGƯỜI DÙNG
// ========================
model SYS_USERS {
  userId       BigInt    @id @default(autoincrement())
  rowguid      String    @default(uuid()) @db.Uuid @unique
  email        String    @unique @db.VarChar(100)
  username     String    @db.VarChar(50)
  password     String    @db.VarChar(200)
  expiredate   DateTime? @db.Timestamp(6)
  birthday     DateTime? @db.Timestamp(6)
  address      String?   @db.VarChar(500)
  telphone     String?   @db.VarChar(50)
  isactive     Boolean   @default(true)
  role         String    @db.VarChar(20)

  createdby    String    @db.VarChar(20)
  createdtime  DateTime  @db.Timestamp(6)
  modifiedby   String?   @db.VarChar(20)
  modifiedtime DateTime? @db.Timestamp(6)

  orders       Order[]

  @@index([email])
  @@index([username])
  @@index([role])
  @@index([isactive])
  @@map("SYS_USERS")
}

// ========================
// BUNDLE PLUGIN
// ========================
model Bundle {
  bundleId      BigInt        @id @default(autoincrement())
  code          String        @unique
  name          String        @db.VarChar(200)
  description   String?       @db.Text
  priceStrategy PriceStrategy @default(SUM)
  discountValue Decimal?      @db.Decimal(10, 2)
  fixedPrice    Decimal?      @db.Decimal(10, 2)

  createdby     String        @db.VarChar(20)
  createdtime   DateTime      @db.Timestamp(6)
  modifiedby    String?       @db.VarChar(20)
  modifiedtime  DateTime?     @db.Timestamp(6)

  items         BundleItem[]
  orderLines    OrderLine[]   @relation("BundleToOrderLine")

  @@index([code])
  @@index([priceStrategy])
  @@index([createdby])
  @@map("bundle")
}

model BundleItem {
  bundleItemId   BigInt         @id @default(autoincrement())
  bundleId       BigInt
  variantId      BigInt
  quantity       Int            @default(1)

  createdby    String           @db.VarChar(20)
  createdtime  DateTime         @db.Timestamp(6)
  modifiedby   String?          @db.VarChar(20)
  modifiedtime DateTime?        @db.Timestamp(6)

  bundle         Bundle         @relation(fields: [bundleId], references: [bundleId], onDelete: Cascade)
  productVariant ProductVariant @relation(fields: [variantId], references: [variantId], onDelete: Restrict)

  @@unique([bundleId, variantId]) // Validation: không trùng variant
  @@index([bundleId])
  @@index([variantId])
  @@map("bundle_item")
}

// ========================
// PRODUCT VARIANT
// ========================
model ProductVariant {
  variantId      BigInt       @id @default(autoincrement())
  sku            String       @unique @db.VarChar(50)
  name           String       @db.VarChar(200)
  price          Decimal      @db.Decimal(10, 2)
  stockOnHand    Int          @default(0)
  reservedStock  Int          @default(0)
  allocatedStock Int          @default(0)

  createdby      String       @db.VarChar(20)
  createdtime    DateTime     @db.Timestamp(6)
  modifiedby     String?      @db.VarChar(20)
  modifiedtime   DateTime?    @db.Timestamp(6)

  bundleItems    BundleItem[]
  orderLines     OrderLine[]

  @@index([sku])
  @@map("product_variant")
}

// ========================
// ORDER & ORDERLINE (CART + BUNDLE)
// ========================
model Order {
  orderId      BigInt      @id @default(autoincrement())
  userId       String      @db.Uuid
  status       OrderStatus @default(CART)
  totalAmount  Decimal     @db.Decimal(10, 2)

  createdby    String      @db.VarChar(20)
  createdtime  DateTime    @db.Timestamp(6)
  modifiedby   String?     @db.VarChar(20)
  modifiedtime DateTime?   @db.Timestamp(6)

  orderLines  OrderLine[]
  user        SYS_USERS   @relation(fields: [userId], references: [userId], onDelete: Restrict)

  @@index([userId, status])
  @@index([status])
  @@index([createdby])
  @@map("order")
}

model OrderLine {
  orderLineId    BigInt             @id @default(autoincrement())
  orderId        BigInt
  bundleId       BigInt?
  variantId      BigInt?
  quantity       Int
  unitPrice      Decimal            @db.Decimal(10, 2)
  totalPrice     Decimal            @db.Decimal(10, 2)
  metadata       Json?              // Lưu chi tiết bundle: items, strategy, originalPrice...

  createdby      String             @db.VarChar(20)
  createdtime    DateTime           @db.Timestamp(6)
  modifiedby     String?            @db.VarChar(20)
  modifiedtime   DateTime?          @db.Timestamp(6)

  order          Order              @relation(fields: [orderId], references: [orderId], onDelete: Cascade)
  bundle         Bundle?            @relation("BundleToOrderLine", fields: [bundleId], references: [bundleId])
  productVariant ProductVariant?    @relation(fields: [variantId], references: [variantId])

  @@index([orderId])
  @@index([bundleId])
  @@index([variantId])
  @@map("order_line")
}